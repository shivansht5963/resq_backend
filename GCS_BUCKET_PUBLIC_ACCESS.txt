GCS BUCKET CONFIGURATION FOR PUBLIC IMAGE ACCESS
==================================================

## PROBLEMS FIXED

### Issue 1: 403 AccessDenied Error
- **Cause**: Bucket not configured for public access
- **Solution**: Make bucket publicly readable

### Issue 2: NoSuchKey Error (File not found in GCS)
- **Cause**: Database record exists but file not in GCS, or serializer building wrong URL
- **Solution**: Fix serializer + verify upload succeeded

## SOLUTION CHECKLIST

### Step 1: Disable Uniform Bucket-Level Access (CRITICAL)

The bucket MUST use object-level ACLs, NOT uniform bucket-level access:

**Via Cloud Console:**
1. Go to Cloud Storage > Buckets
2. Click "resq-campus-security"
3. Click "Permissions" tab
4. Find "Uniform bucket-level access" section
5. Click "Edit" (pencil icon)
6. Toggle OFF "Enforce uniform bucket-level access"
7. Click "Save"

**Via gcloud:**
```bash
gsutil uniformbucketlevelaccess set off gs://resq-campus-security
```

**Verify:**
```bash
gsutil uniformbucketlevelaccess get gs://resq-campus-security
# Should show: Uniform bucket-level access: Disabled
```

### Step 2: Set Bucket-Level Permissions

Run in Google Cloud Console (gcloud CLI):

```bash
# Make bucket publicly readable for anonymous users
gsutil iam ch serviceAccount:allUsers:objectViewer gs://resq-campus-security

# Or using Cloud Console:
# 1. Go to Cloud Storage > Buckets
# 2. Click "resq-campus-security"
# 3. Click "Permissions" tab
# 4. Click "Grant Access"
# 5. New principal: "allUsers"
# 6. Role: "Storage Object Viewer"
# 7. Click "Save"
```

### Step 3: Restart Django Server

```bash
# Kill existing process
# python manage.py runserver

# Restart with fresh storage backend
# python manage.py runserver
```

### Step 4: Check Database vs GCS

Before fixing anything, diagnose the issue:

```bash
python manage.py shell < check_image_storage.py
```

This shows:
- How many images are in database
- How many actually exist in GCS
- Which ones are missing
- URL status for each

### Step 5: Fix Orphaned Records (if needed)

If check_image_storage.py shows missing files:

```bash
python manage.py shell < fix_missing_images.py
```

This safely deletes database records for files that don't exist in GCS.

### Step 6: Fix Existing Images (if already uploaded)

Make all existing images public:

```bash
python manage.py shell < fix_image_permissions.py
```



```bash
# In Django shell
python manage.py shell
```

Then run:
```python
from fix_image_permissions import fix_image_permissions
fix_image_permissions()
```

Or via command line:
```bash
python fix_image_permissions.py
```

### Step 4: Verify Configuration

Test with curl:

```bash
# Should return image data (not 403 error)
curl -I "https://storage.googleapis.com/resq-campus-security/incidents/2026/01/12/image.jpg"

# Response should be:
# HTTP/1.1 200 OK
# Content-Type: image/jpeg
# Content-Length: xxxxx
```

## WHAT CHANGED

### storage.py
- Changed from signed URLs (7-day expiration) to direct public URLs
- New images are made public via blob.make_public() in save()
- Direct URL format: https://storage.googleapis.com/{bucket}/{path}

### incidents/models.py
- Added save() method to IncidentImage model
- Automatically calls blob.make_public() when image is uploaded
- Handles errors gracefully (image saves even if make_public fails)

### API Response Format (UNCHANGED)
Images in API response still use same format:
```json
{
  "images": [
    {
      "id": 22,
      "image": "https://storage.googleapis.com/resq-campus-security/incidents/2026/01/12/photo.jpg",
      "uploaded_by_name": "John Doe",
      "uploaded_at": "2026-01-12T20:15:30+05:30",
      "description": "Front view"
    }
  ]
}
```

## TESTING

### 1. Test Direct URL Access
```bash
# Open in browser or curl
https://storage.googleapis.com/resq-campus-security/incidents/2026/01/12/image.jpg

# Should display image (not 403 error)
```

### 2. Test Frontend Access
```javascript
// React/React Native
<img src="https://storage.googleapis.com/resq-campus-security/incidents/2026/01/12/image.jpg" />

// Should load image without 403
```

### 3. Test API Response
```bash
curl -H "Authorization: Token YOUR_TOKEN" \
  https://api.example.com/api/incidents/550e8400-e29b-41d4-a716-446655440000/

# Response should include:
# "image": "https://storage.googleapis.com/resq-campus-security/incidents/2026/01/12/image.jpg"

# Access that URL directly in browser - should work now
```

## TROUBLESHOOTING

### Still Getting 403 Error?

1. **Check bucket configuration:**
   ```bash
   gsutil uniformbucketlevelaccess get gs://resq-campus-security
   # Should output: Uniform bucket-level access: Disabled
   ```

2. **Check blob ACL:**
   ```bash
   gsutil acl ch -u AllUsers:R gs://resq-campus-security/incidents/2026/01/12/image.jpg
   # This makes the specific blob public
   ```

3. **Re-run fix script:**
   ```bash
   python fix_image_permissions.py
   ```

4. **Restart Django:**
   ```bash
   # Kill and restart your Django server
   # This clears any cached permissions
   ```

5. **Check service account permissions:**
   - Service account should have roles/storage.admin for the bucket
   - Verify in Cloud IAM console

## SECURITY NOTES

⚠️ This makes images PUBLICLY READABLE on the internet
- Anyone with the URL can view the image
- Images are stored in incidents folder (considered public information)
- Sensitive information should NOT be in images

For private images:
- Use signed URLs instead (restore old storage.py code)
- Add authentication to image access
- Implement access control in views

## DEPLOYMENT

When deploying to production:

1. Configure production GCS bucket same way:
   - Disable uniform bucket-level access
   - Add public read permissions

2. Run fix_image_permissions.py on production for existing images

3. Verify with actual image URLs from production database

4. Monitor GCS costs (public access = higher bandwidth)

