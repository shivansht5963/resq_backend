TESTING INCIDENT IMAGES - QUICK START GUIDE
============================================

## FILES PROVIDED

1. test_images.http - Organized by step numbers [1.0 - 14.4]
2. test_incident_images_workflow.http - Complete workflow with phases [1-7] + verification [V1-V5]
3. test_incident_images_api.py - Automated Python test suite (already passing)

## WHAT TO TEST

### A. Create Incident WITH Images
✓ Student reports incident with 1-3 images
✓ Response includes images array with URLs
✓ Each image has: id, image (URL), uploaded_by_email, uploaded_by_name, uploaded_at, description

### B. View Incident - Student
✓ GET /api/incidents/{id}/ returns all images
✓ Image URLs are absolute HTTPS (start with https://storage.googleapis.com/)
✓ Can display images directly in UI

### C. View Incident - Guard
✓ Guard sees same images as student
✓ Full incident details available to guard
✓ Images can be viewed before accepting alert

### D. List Incidents
✓ List endpoint includes "image_count" field
✓ Shows how many images per incident
✓ Lightweight response without full image data

## SETUP BEFORE TESTING

1. Open test_incident_images_workflow.http in VS Code
2. Install "REST Client" extension (if not already installed)
3. Update these values at the top:
   - @studentToken = YOUR_TOKEN (from login)
   - @guardToken = YOUR_TOKEN (from login)
   - @adminToken = YOUR_TOKEN (from login)

## TESTING FLOW

### Phase 1: Get Tokens
```
Run [1.0] LOGIN STUDENT
- Copy response token to @studentToken

Run [1.1] LOGIN GUARD
- Copy response token to @guardToken
```

### Phase 2: Get Beacon ID
```
Run [1.4] LIST ALL BEACONS
- Copy any beacon "id" to @beaconId
- Or create test beacon first
```

### Phase 3: Create Incident WITH Images
```
Run [2.1] REPORT INCIDENT WITH IMAGES
- Make sure image files exist or comment out image section
- Response will have incident_id
- Copy to @incidentId
```

### Phase 4: Verify Images in Response
```
Run [3.0] GET INCIDENT DETAILS
- Check response includes "images" array
- Verify each image has:
  ✓ id
  ✓ image (absolute URL)
  ✓ uploaded_by_email
  ✓ uploaded_by_name
  ✓ uploaded_at
  ✓ description
```

### Phase 5: Guard Views Images
```
Run [4.1] GUARD: VIEW INCIDENT WITH IMAGES
- Guard should see same images as student
- Verify image URLs work
```

### Phase 6: Verify Image Count
```
Run [3.1] LIST MY INCIDENTS
- Check "image_count" field for incident
- Should show 2-3 (from step 3)
```

## KEY VERIFICATION CHECKS

✓ [V1] - Images in incident response
✓ [V2] - Image URLs are absolute (HTTPS)
✓ [V3] - Image count in list view
✓ [V4] - Guard sees all images
✓ [V5] - Push notifications include images

## EXPECTED RESPONSES

### GET /api/incidents/{id}/
```json
{
  "id": "incident-uuid",
  "status": "CREATED",
  "priority": 3,
  "description": "...",
  "images": [
    {
      "id": 22,
      "image": "https://storage.googleapis.com/resq-campus-security/incidents/2026/01/12/image.jpg",
      "uploaded_by_email": "student@example.com",
      "uploaded_by_name": "Student Name",
      "uploaded_at": "2026-01-12T20:19:08.962832+05:30",
      "description": "Image description"
    }
  ]
}
```

### GET /api/incidents/ (List)
```json
{
  "results": [
    {
      "id": "incident-uuid",
      "image_count": 2,
      "signal_count": 1,
      "status": "CREATED",
      "priority": 3
    }
  ]
}
```

## COMMON ISSUES & FIXES

### Issue: "No such file" when uploading images
**Fix:** Update image file paths in [2.1] to point to actual files, or:
- Create test images: Run test_incident_images_api.py which creates test data
- Comment out image section to skip image upload
- Test with [2.0] (report_sos) instead which doesn't require images

### Issue: Images not in response
**Fix:**
- Check incident was created with images (check response from [2.1])
- Verify database has images (Run [V1] check)
- Check uploader has permission to upload

### Issue: Token invalid
**Fix:**
- Re-login: Run [1.0] or [1.1]
- Copy new token to @studentToken or @guardToken
- Verify token format: Should start with numbers/letters, no spaces

### Issue: Beacon ID not found
**Fix:**
- Run [1.4] to list all beacons
- Copy any "id" value to @beaconId
- Or use reported beacon ID from previous test

### Issue: Image URLs don't work
**Fix:**
- Verify URL starts with https://storage.googleapis.com/
- Check Google Cloud Storage is configured
- Test URL in browser directly

## TESTING CHECKLIST

- [ ] Student token obtained
- [ ] Guard token obtained
- [ ] Beacon ID obtained
- [ ] Incident created with images
- [ ] Images in response (absolute URLs)
- [ ] Image count in list view
- [ ] Guard sees images
- [ ] All URLs are HTTPS
- [ ] All image metadata present
- [ ] Test with [V1-V5] verification

## FRONTEND INTEGRATION NOTES

After testing API responses, frontend can:

1. Parse 'images' array from incident response
2. Display images using the 'image' field directly (absolute URL)
3. Show uploader info: 'uploaded_by_name' and 'uploaded_by_email'
4. Show timestamp: 'uploaded_at'
5. Show count: 'image_count' from list view

Images are ready to display - no additional processing needed!

## NEXT STEPS

1. Run test_incident_images_workflow.http following phases 1-7
2. Run verification checks [V1-V5]
3. Confirm all images visible to both student and guard
4. Test with actual mobile app (push notifications)
5. Deploy to production when ready

